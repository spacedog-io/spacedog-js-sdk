(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
  typeof define === 'function' && define.amd ? define(factory) :
  (global.SpaceDog = factory());
}(this, (function () { 'use strict';

var Config = {

    backendId: null,

    default_authorization_header: null

};

var UrlBuilder = {
    forLogin: function forLogin() {
        return 'https://' + Config.backendId + '.spacedog.io/1/login';
    },
    forSchema: function forSchema() {
        return 'https://' + Config.backendId + '.spacedog.io/1/schema';
    },
    forSearch: function forSearch(type) {
        return 'https://' + Config.backendId + '.spacedog.io/1/search/' + type;
    }
};

var _xend = function _xend(method, payload, url, cb) {

    var data = null;
    if (payload) {
        data = JSON.stringify(payload);
    }

    var xhr = new XMLHttpRequest();

    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
            try {
                var json = JSON.parse(xhr.responseText);

                // console.log("-----\nSpaceDog.Xhr# SUCCESS 88 xhr.responseText (=",xhr.responseText,") \n\n (xhr.url=",xhr.url,") \n\n (xhr.method=",xhr.method,") \n\n (xhr=",xhr,"\n\n-------\n")

                if (json.success == false || !(xhr.status >= 200 && xhr.status < 300)) {
                    cb(json, null);
                } else {
                    cb(null, json);
                }
            } catch (e) {
                console.warn("-----\nSpaceDog.Xhr# could not parse xhr.responseText (=", xhr.responseText, ") \n\n (xhr.url=", xhr.url, ") \n\n (xhr.method=", xhr.method, ") \n\n (xhr=", xhr, ") and therefore not able to 1/ set authorization headers 2/ remember user token, if rememberMe is true\n\nPossibly something else. Check the caught exeption:\n\n", e, "\n\n-------\n");
                cb(xhr.responseText, null);
            }
        }
    };

    xhr.open(method, url);
    xhr.setRequestHeader("content-type", "application/json");

    if (Config.default_authorization_header != null) {
        xhr.setRequestHeader("authorization", Config.default_authorization_header);
    }

    if (data == null) {
        xhr.send();
    } else {
        xhr.send(data);
    }
};

var UtilXHR = {
    get: function get(url, cb) {
        _xend("GET", null, url, cb);
    },
    post: function post(payload, url, cb) {
        _xend("POST", payload, url, cb);
    }
};

var Credentials = {
    /**
     * opts : { username:string, password:string, rememberMe:bool }
     * cb : callback function
     */
    login: function login(opts, cb) {

        try {
            Config.default_authorization_header = "Basic " + new Buffer(opts.username + ":" + opts.password).toString('base64');
        } catch (e) {
            Config.default_authorization_header = "Basic " + btoa(opts.username + ":" + opts.password);
        }

        UtilXHR.get(UrlBuilder.forLogin(), function (err, data) {

            if (err != null) {

                Config.default_authorization_header = null;
            } else {

                Config.default_authorization_header = "Bearer " + data.accessToken;

                if (opts.rememberMe) {

                    localStorage.setItem('SPACEDOG_CREDENTIALS_TOKEN', JSON.stringify({
                        "accessToken": data.accessToken,
                        "backendId": Config.backendId
                    }));
                }
            }

            cb(err, data);
        });
    },
    loginWithSavedCredentials: function loginWithSavedCredentials(cb) {

        var saved = JSON.parse(localStorage.getItem('SPACEDOG_CREDENTIALS_TOKEN'));

        Config.backendId = saved.backendId;

        Config.default_authorization_header = "Bearer " + saved.accessToken;

        UtilXHR.get(UrlBuilder.forLogin(), function (err, data) {

            if (err == null) {

                Config.default_authorization_header = "Bearer " + data.accessToken;
            }

            cb(err, data);
        });
    },
    forget: function forget() {
        Config.default_authorization_header = null;
        localStorage.removeItem('SPACEDOG_CREDENTIALS_TOKEN');
    },
    getRememberedState: function getRememberedState() {
        return JSON.parse(localStorage.getItem('SPACEDOG_CREDENTIALS_TOKEN'));
    },
    canTryLogin: function canTryLogin() {
        return localStorage.getItem('SPACEDOG_CREDENTIALS_TOKEN') != undefined && localStorage.getItem('SPACEDOG_CREDENTIALS_TOKEN') != null;
    }
};

var classCallCheck = function (instance, Constructor) {
  if (!(instance instanceof Constructor)) {
    throw new TypeError("Cannot call a class as a function");
  }
};

var createClass = function () {
  function defineProperties(target, props) {
    for (var i = 0; i < props.length; i++) {
      var descriptor = props[i];
      descriptor.enumerable = descriptor.enumerable || false;
      descriptor.configurable = true;
      if ("value" in descriptor) descriptor.writable = true;
      Object.defineProperty(target, descriptor.key, descriptor);
    }
  }

  return function (Constructor, protoProps, staticProps) {
    if (protoProps) defineProperties(Constructor.prototype, protoProps);
    if (staticProps) defineProperties(Constructor, staticProps);
    return Constructor;
  };
}();

var PaginationSession = function () {
    function PaginationSession(from, size) {
        classCallCheck(this, PaginationSession);

        this._from = from;
        this._size = size;
        this._total = null;
    }

    createClass(PaginationSession, [{
        key: "isNextPageAvailable",
        value: function isNextPageAvailable() {
            if (this._total == null) {
                return true;
            }
            return this._from + this._size < this._total;
        }
    }, {
        key: "isPrevPageAvailable",
        value: function isPrevPageAvailable() {
            if (this._total == null) {
                return false;
            }
            // console.log("isPrevPageAvailable from=", this._from, "size=", this._size)
            return this._from >= this._size;
        }
    }, {
        key: "_newPageLoaded",
        value: function _newPageLoaded(result) {
            this._total = result.total;
        }
    }, {
        key: "pointNextPage",
        value: function pointNextPage() {
            this._from += this._size;
        }
    }, {
        key: "pointPrevPage",
        value: function pointPrevPage() {
            this._from -= this._size;
        }
    }, {
        key: "getFrom",
        value: function getFrom() {
            return this._from;
        }
    }, {
        key: "getSize",
        value: function getSize() {
            return this._size;
        }
    }]);
    return PaginationSession;
}();

var Data = {

    PaginationSession: PaginationSession,

    /**
     * opts : { type:string }
     * cb : callback function
     * paginationSession : optional paginationSession
     */
    search: function search(opts, cb, paginationSession) {

        if (opts.payload == undefined) {
            opts.payload = {};
        }

        if (paginationSession) {

            opts.payload.from = paginationSession.getFrom(), opts.payload.size = paginationSession.getSize();
        }

        UtilXHR.post(opts.payload, UrlBuilder.forSearch(opts.type), function (err, data) {
            if (err != null) {
                cb(err, data);
            } else {

                if (paginationSession) paginationSession._newPageLoaded(data);

                cb(err, data);
            }
        });
    }
};

var Schema = {

  /**
   * cb : callback function
   */
  list: function list(cb) {

    UtilXHR.get(UrlBuilder.forSchema(), cb);
  }
};

var SpaceDog = {
    initialize: function initialize(backendId) {
        if (backendId == undefined) {
            throw "BackendId is required.";
        }
        Config.backendId = backendId;
    },
    getBackendId: function getBackendId() {
        return Config.backendId;
    },
    forgetAll: function forgetAll() {
        Config.backendId = null;
        Config.default_authorization_header = null;
    }
};

SpaceDog._Config = Config; // pas en release ?
SpaceDog.Credentials = Credentials;
SpaceDog.Data = Data;
SpaceDog.Schema = Schema;

return SpaceDog;

})));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjpudWxsLCJzb3VyY2VzIjpbInNyYy9saWIvY29uZmlnLmpzIiwic3JjL2xpYi91cmxCdWlsZGVyLmpzIiwic3JjL2xpYi91dGlsWGhyLmpzIiwic3JjL2xpYi9jcmVkZW50aWFscy5qcyIsInNyYy9saWIvcGFnaW5hdGlvblNlc3Npb24uanMiLCJzcmMvbGliL2RhdGEuanMiLCJzcmMvbGliL3NjaGVtYS5qcyIsInNyYy9zcGFjZWRvZy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgZGVmYXVsdCB7XG5cbiAgICBiYWNrZW5kSWQ6bnVsbCxcblxuICAgIGRlZmF1bHRfYXV0aG9yaXphdGlvbl9oZWFkZXI6bnVsbFxuXG59IiwiaW1wb3J0IENvbmZpZyBmcm9tICcuL2NvbmZpZy5qcydcblxuXG5leHBvcnQgZGVmYXVsdCB7XG5cbiAgICBmb3JMb2dpbiAoKSB7XG4gICAgICAgIHJldHVybiBgaHR0cHM6Ly8ke0NvbmZpZy5iYWNrZW5kSWR9LnNwYWNlZG9nLmlvLzEvbG9naW5gXG4gICAgfSxcblxuICAgIGZvclNjaGVtYSAoKSB7XG4gICAgICAgIHJldHVybiBgaHR0cHM6Ly8ke0NvbmZpZy5iYWNrZW5kSWR9LnNwYWNlZG9nLmlvLzEvc2NoZW1hYCAgXG4gICAgfSxcblxuICAgIGZvclNlYXJjaCAodHlwZSkge1xuICAgICAgICByZXR1cm4gYGh0dHBzOi8vJHtDb25maWcuYmFja2VuZElkfS5zcGFjZWRvZy5pby8xL3NlYXJjaC9gK3R5cGVcbiAgICB9XG5cblxuXG59IiwiaW1wb3J0IENvbmZpZyBmcm9tICcuL2NvbmZpZydcblxudmFyIF94ZW5kID0gZnVuY3Rpb24obWV0aG9kLCBwYXlsb2FkLCB1cmwsIGNiKXtcblxuICAgIHZhciBkYXRhID0gbnVsbDtcbiAgICBpZiAocGF5bG9hZCkge1xuICAgICAgICBkYXRhID0gSlNPTi5zdHJpbmdpZnkocGF5bG9hZCk7XG4gICAgfVxuXG4gICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuXG4gICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PT0gNCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdmFyIGpzb24gPSBKU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQpO1xuXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIi0tLS0tXFxuU3BhY2VEb2cuWGhyIyBTVUNDRVNTIDg4IHhoci5yZXNwb25zZVRleHQgKD1cIix4aHIucmVzcG9uc2VUZXh0LFwiKSBcXG5cXG4gKHhoci51cmw9XCIseGhyLnVybCxcIikgXFxuXFxuICh4aHIubWV0aG9kPVwiLHhoci5tZXRob2QsXCIpIFxcblxcbiAoeGhyPVwiLHhocixcIlxcblxcbi0tLS0tLS1cXG5cIilcblxuICAgICAgICAgICAgaWYgKGpzb24uc3VjY2Vzcz09ZmFsc2UgfHwgISh4aHIuc3RhdHVzID49IDIwMCAmJiB4aHIuc3RhdHVzIDwgMzAwICkpIHtcbiAgICAgICAgICAgICAgICBjYihqc29uLCBudWxsKVxuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNiKG51bGwsIGpzb24pXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKFwiLS0tLS1cXG5TcGFjZURvZy5YaHIjIGNvdWxkIG5vdCBwYXJzZSB4aHIucmVzcG9uc2VUZXh0ICg9XCIseGhyLnJlc3BvbnNlVGV4dCxcIikgXFxuXFxuICh4aHIudXJsPVwiLHhoci51cmwsXCIpIFxcblxcbiAoeGhyLm1ldGhvZD1cIix4aHIubWV0aG9kLFwiKSBcXG5cXG4gKHhocj1cIix4aHIsXCIpIGFuZCB0aGVyZWZvcmUgbm90IGFibGUgdG8gMS8gc2V0IGF1dGhvcml6YXRpb24gaGVhZGVycyAyLyByZW1lbWJlciB1c2VyIHRva2VuLCBpZiByZW1lbWJlck1lIGlzIHRydWVcXG5cXG5Qb3NzaWJseSBzb21ldGhpbmcgZWxzZS4gQ2hlY2sgdGhlIGNhdWdodCBleGVwdGlvbjpcXG5cXG5cIiwgZSxcIlxcblxcbi0tLS0tLS1cXG5cIilcbiAgICAgICAgICAgIGNiKHhoci5yZXNwb25zZVRleHQsIG51bGwpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB4aHIub3BlbihtZXRob2QsIHVybCk7XG4gICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoXCJjb250ZW50LXR5cGVcIiwgXCJhcHBsaWNhdGlvbi9qc29uXCIpO1xuXG4gICAgaWYgKENvbmZpZy5kZWZhdWx0X2F1dGhvcml6YXRpb25faGVhZGVyICE9IG51bGwpIHtcbiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoXCJhdXRob3JpemF0aW9uXCIsIENvbmZpZy5kZWZhdWx0X2F1dGhvcml6YXRpb25faGVhZGVyKVxuICAgIH1cblxuICAgIGlmIChkYXRhID09IG51bGwpIHtcbiAgICAgICAgeGhyLnNlbmQoKVxuICAgIH0gZWxzZSB7XG4gICAgICAgIHhoci5zZW5kKGRhdGEpO1xuICAgIH1cblxufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gICAgZ2V0ICh1cmwsIGNiKSB7XG4gICAgICAgIF94ZW5kKFwiR0VUXCIsIG51bGwsIHVybCwgY2IpXG4gICAgfSxcblxuICAgIHBvc3QgKHBheWxvYWQsIHVybCwgY2IpIHtcbiAgICAgICAgX3hlbmQoXCJQT1NUXCIsIHBheWxvYWQsIHVybCwgY2IpXG4gICAgfVxufSIsImltcG9ydCBVcmxCdWlsZGVyIGZyb20gJy4vdXJsQnVpbGRlci5qcydcbmltcG9ydCBDb25maWcgZnJvbSAnLi9jb25maWcuanMnXG5pbXBvcnQgVXRpbFhIUiBmcm9tICcuL3V0aWxYaHInXG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgICAvKipcbiAgICAgKiBvcHRzIDogeyB1c2VybmFtZTpzdHJpbmcsIHBhc3N3b3JkOnN0cmluZywgcmVtZW1iZXJNZTpib29sIH1cbiAgICAgKiBjYiA6IGNhbGxiYWNrIGZ1bmN0aW9uXG4gICAgICovXG4gICAgbG9naW4gKG9wdHMsIGNiKSB7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIENvbmZpZy5kZWZhdWx0X2F1dGhvcml6YXRpb25faGVhZGVyID0gXCJCYXNpYyBcIituZXcgQnVmZmVyKG9wdHMudXNlcm5hbWUrXCI6XCIrb3B0cy5wYXNzd29yZCkudG9TdHJpbmcoJ2Jhc2U2NCcpXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIENvbmZpZy5kZWZhdWx0X2F1dGhvcml6YXRpb25faGVhZGVyID0gXCJCYXNpYyBcIitidG9hKG9wdHMudXNlcm5hbWUrXCI6XCIrb3B0cy5wYXNzd29yZClcbiAgICAgICAgfVxuXG4gICAgICAgIFV0aWxYSFIuZ2V0KFVybEJ1aWxkZXIuZm9yTG9naW4oKSwgZnVuY3Rpb24oZXJyLCBkYXRhKSB7XG5cbiAgICAgICAgICAgIGlmIChlcnIgIT0gbnVsbCkge1xuXG4gICAgICAgICAgICAgICAgQ29uZmlnLmRlZmF1bHRfYXV0aG9yaXphdGlvbl9oZWFkZXIgPSBudWxsICAgICAgICAgICAgICAgIFxuXG4gICAgICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICAgICAgQ29uZmlnLmRlZmF1bHRfYXV0aG9yaXphdGlvbl9oZWFkZXIgPSBcIkJlYXJlciBcIitkYXRhLmFjY2Vzc1Rva2VuXG5cbiAgICAgICAgICAgICAgICBpZiAob3B0cy5yZW1lbWJlck1lKSB7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ1NQQUNFRE9HX0NSRURFTlRJQUxTX1RPS0VOJywgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgICAgICBcImFjY2Vzc1Rva2VuXCI6ZGF0YS5hY2Nlc3NUb2tlbixcbiAgICAgICAgICAgICAgICAgICAgXCJiYWNrZW5kSWRcIjpDb25maWcuYmFja2VuZElkXG4gICAgICAgICAgICAgICAgICB9KSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNiKGVyciwgZGF0YSlcblxuICAgICAgICB9KVxuXG4gICAgfSxcblxuICAgIGxvZ2luV2l0aFNhdmVkQ3JlZGVudGlhbHMgKGNiKSAge1xuXG4gICAgICAgIHZhciBzYXZlZCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ1NQQUNFRE9HX0NSRURFTlRJQUxTX1RPS0VOJykpXG5cbiAgICAgICAgQ29uZmlnLmJhY2tlbmRJZCA9IHNhdmVkLmJhY2tlbmRJZFxuXG4gICAgICAgIENvbmZpZy5kZWZhdWx0X2F1dGhvcml6YXRpb25faGVhZGVyID0gXCJCZWFyZXIgXCIrc2F2ZWQuYWNjZXNzVG9rZW5cblxuICAgICAgICBVdGlsWEhSLmdldChVcmxCdWlsZGVyLmZvckxvZ2luKCksIGZ1bmN0aW9uKGVyciwgZGF0YSkge1xuXG4gICAgICAgICAgICBpZiAoZXJyID09IG51bGwpIHtcblxuICAgICAgICAgICAgICAgIENvbmZpZy5kZWZhdWx0X2F1dGhvcml6YXRpb25faGVhZGVyID0gXCJCZWFyZXIgXCIrZGF0YS5hY2Nlc3NUb2tlblxuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNiKGVyciwgZGF0YSlcblxuICAgICAgICB9KVxuXG4gICAgfSxcblxuXG4gICAgZm9yZ2V0ICgpIHtcbiAgICAgICAgQ29uZmlnLmRlZmF1bHRfYXV0aG9yaXphdGlvbl9oZWFkZXIgPSBudWxsXG4gICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCdTUEFDRURPR19DUkVERU5USUFMU19UT0tFTicpXG4gICAgfSxcblxuICAgIGdldFJlbWVtYmVyZWRTdGF0ZSAoKSB7XG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdTUEFDRURPR19DUkVERU5USUFMU19UT0tFTicpKVxuICAgIH0sXG5cbiAgICBjYW5UcnlMb2dpbiAoKSB7XG4gICAgICAgIHJldHVybiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnU1BBQ0VET0dfQ1JFREVOVElBTFNfVE9LRU4nKSE9dW5kZWZpbmVkICYmIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdTUEFDRURPR19DUkVERU5USUFMU19UT0tFTicpIT1udWxsXG4gICAgfVxufSIsIlxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGFnaW5hdGlvblNlc3Npb24ge1xuXG4gICAgY29uc3RydWN0b3IoZnJvbSwgc2l6ZSkge1xuICAgICAgICB0aGlzLl9mcm9tID0gZnJvbVxuICAgICAgICB0aGlzLl9zaXplID0gc2l6ZVxuICAgICAgICB0aGlzLl90b3RhbCA9IG51bGxcbiAgICB9XG5cbiAgICBpc05leHRQYWdlQXZhaWxhYmxlICgpIHtcbiAgICAgICAgaWYgKHRoaXMuX3RvdGFsID09IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuX2Zyb20gKyB0aGlzLl9zaXplIDwgdGhpcy5fdG90YWxcbiAgICB9XG5cblxuICAgIGlzUHJldlBhZ2VBdmFpbGFibGUgKCkge1xuICAgICAgICBpZiAodGhpcy5fdG90YWwgPT0gbnVsbCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgIH1cbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJpc1ByZXZQYWdlQXZhaWxhYmxlIGZyb209XCIsIHRoaXMuX2Zyb20sIFwic2l6ZT1cIiwgdGhpcy5fc2l6ZSlcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Zyb20gPj0gdGhpcy5fc2l6ZVxuICAgIH1cblxuICAgIF9uZXdQYWdlTG9hZGVkIChyZXN1bHQpIHtcbiAgICAgICAgdGhpcy5fdG90YWwgPSByZXN1bHQudG90YWxcbiAgICB9XG5cbiAgICBwb2ludE5leHRQYWdlICgpIHtcbiAgICAgICAgdGhpcy5fZnJvbSArPSB0aGlzLl9zaXplXG4gICAgfVxuXG4gICAgcG9pbnRQcmV2UGFnZSAoKSB7XG4gICAgICAgIHRoaXMuX2Zyb20gLT0gdGhpcy5fc2l6ZVxuICAgIH1cblxuICAgIGdldEZyb20gKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZnJvbVxuICAgIH1cblxuICAgIGdldFNpemUgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fc2l6ZVxuICAgIH1cblxufSIsImltcG9ydCBVcmxCdWlsZGVyIGZyb20gJy4vdXJsQnVpbGRlci5qcydcbmltcG9ydCBVdGlsWEhSIGZyb20gJy4vdXRpbFhocidcbmltcG9ydCBQYWdpbmF0aW9uU2Vzc2lvbiBmcm9tICcuL3BhZ2luYXRpb25TZXNzaW9uLmpzJ1xuXG52YXIgRGF0YSA9IHtcbiAgICBcbiAgICBQYWdpbmF0aW9uU2Vzc2lvbiA6IFBhZ2luYXRpb25TZXNzaW9uLFxuXG4gICAgLyoqXG4gICAgICogb3B0cyA6IHsgdHlwZTpzdHJpbmcgfVxuICAgICAqIGNiIDogY2FsbGJhY2sgZnVuY3Rpb25cbiAgICAgKiBwYWdpbmF0aW9uU2Vzc2lvbiA6IG9wdGlvbmFsIHBhZ2luYXRpb25TZXNzaW9uXG4gICAgICovXG4gICAgc2VhcmNoIChvcHRzLCBjYiwgcGFnaW5hdGlvblNlc3Npb24pIHtcblxuICAgICAgICBpZiAob3B0cy5wYXlsb2FkID09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgb3B0cy5wYXlsb2FkID0ge31cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwYWdpbmF0aW9uU2Vzc2lvbikge1xuXG4gICAgICAgICAgICBvcHRzLnBheWxvYWQuZnJvbSA9IHBhZ2luYXRpb25TZXNzaW9uLmdldEZyb20oKSxcbiAgICAgICAgICAgIG9wdHMucGF5bG9hZC5zaXplID0gcGFnaW5hdGlvblNlc3Npb24uZ2V0U2l6ZSgpXG5cbiAgICAgICAgfVxuXG4gICAgICAgIFV0aWxYSFIucG9zdChvcHRzLnBheWxvYWQsIFVybEJ1aWxkZXIuZm9yU2VhcmNoKG9wdHMudHlwZSksIGZ1bmN0aW9uKGVyciwgZGF0YSl7XG4gICAgICAgICAgICBpZiAoZXJyICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICBjYihlcnIsIGRhdGEpO1xuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIGlmIChwYWdpbmF0aW9uU2Vzc2lvbilcbiAgICAgICAgICAgICAgICAgICAgcGFnaW5hdGlvblNlc3Npb24uX25ld1BhZ2VMb2FkZWQoZGF0YSlcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjYihlcnIsIGRhdGEpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG59XG5cbmV4cG9ydCBkZWZhdWx0IERhdGEiLCJpbXBvcnQgVXJsQnVpbGRlciBmcm9tICcuL3VybEJ1aWxkZXIuanMnXG5pbXBvcnQgVXRpbFhIUiBmcm9tICcuL3V0aWxYaHIuanMnXG5cbmV4cG9ydCBkZWZhdWx0IHtcblxuICAgIC8qKlxuICAgICAqIGNiIDogY2FsbGJhY2sgZnVuY3Rpb25cbiAgICAgKi9cbiAgICBsaXN0IChjYikge1xuXG4gICAgICBVdGlsWEhSLmdldChVcmxCdWlsZGVyLmZvclNjaGVtYSgpLCBjYilcblxuICAgIH1cbn0iLCJcblxuaW1wb3J0IENvbmZpZyBmcm9tICcuL2xpYi9jb25maWcuanMnXG5pbXBvcnQgQ3JlZGVudGlhbHMgZnJvbSAnLi9saWIvY3JlZGVudGlhbHMuanMnXG5pbXBvcnQgRGF0YSBmcm9tICcuL2xpYi9kYXRhLmpzJ1xuaW1wb3J0IFNjaGVtYSBmcm9tICcuL2xpYi9zY2hlbWEuanMnXG5cbnZhciBTcGFjZURvZyA9IHtcbiAgICBpbml0aWFsaXplIChiYWNrZW5kSWQpIHtcbiAgICAgICAgaWYgKGJhY2tlbmRJZCA9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRocm93IFwiQmFja2VuZElkIGlzIHJlcXVpcmVkLlwiXG4gICAgICAgIH1cbiAgICAgICAgQ29uZmlnLmJhY2tlbmRJZCA9IGJhY2tlbmRJZFxuICAgIH0sXG4gICAgXG4gICAgZ2V0QmFja2VuZElkICgpIHtcbiAgICAgICAgcmV0dXJuIENvbmZpZy5iYWNrZW5kSWRcbiAgICB9LFxuXG4gICAgZm9yZ2V0QWxsICgpIHtcbiAgICAgICAgQ29uZmlnLmJhY2tlbmRJZCA9IG51bGxcbiAgICAgICAgQ29uZmlnLmRlZmF1bHRfYXV0aG9yaXphdGlvbl9oZWFkZXIgPSBudWxsXG4gICAgfVxufVxuXG5cblNwYWNlRG9nLl9Db25maWcgPSBDb25maWcgLy8gcGFzIGVuIHJlbGVhc2UgP1xuU3BhY2VEb2cuQ3JlZGVudGlhbHMgPSBDcmVkZW50aWFsc1xuU3BhY2VEb2cuRGF0YSA9IERhdGFcblNwYWNlRG9nLlNjaGVtYSA9IFNjaGVtYVxuXG5leHBvcnQgZGVmYXVsdCBTcGFjZURvZ1xuIl0sIm5hbWVzIjpbIkNvbmZpZyIsImJhY2tlbmRJZCIsInR5cGUiLCJfeGVuZCIsIm1ldGhvZCIsInBheWxvYWQiLCJ1cmwiLCJjYiIsImRhdGEiLCJKU09OIiwic3RyaW5naWZ5IiwieGhyIiwiWE1MSHR0cFJlcXVlc3QiLCJvbnJlYWR5c3RhdGVjaGFuZ2UiLCJyZWFkeVN0YXRlIiwianNvbiIsInBhcnNlIiwicmVzcG9uc2VUZXh0Iiwic3VjY2VzcyIsInN0YXR1cyIsImUiLCJ3YXJuIiwib3BlbiIsInNldFJlcXVlc3RIZWFkZXIiLCJkZWZhdWx0X2F1dGhvcml6YXRpb25faGVhZGVyIiwic2VuZCIsIm9wdHMiLCJCdWZmZXIiLCJ1c2VybmFtZSIsInBhc3N3b3JkIiwidG9TdHJpbmciLCJidG9hIiwiZ2V0IiwiVXJsQnVpbGRlciIsImZvckxvZ2luIiwiZXJyIiwiYWNjZXNzVG9rZW4iLCJyZW1lbWJlck1lIiwic2V0SXRlbSIsInNhdmVkIiwibG9jYWxTdG9yYWdlIiwiZ2V0SXRlbSIsInJlbW92ZUl0ZW0iLCJ1bmRlZmluZWQiLCJQYWdpbmF0aW9uU2Vzc2lvbiIsImZyb20iLCJzaXplIiwiX2Zyb20iLCJfc2l6ZSIsIl90b3RhbCIsInJlc3VsdCIsInRvdGFsIiwiRGF0YSIsInBhZ2luYXRpb25TZXNzaW9uIiwiZ2V0RnJvbSIsImdldFNpemUiLCJwb3N0IiwiZm9yU2VhcmNoIiwiX25ld1BhZ2VMb2FkZWQiLCJmb3JTY2hlbWEiLCJTcGFjZURvZyIsIl9Db25maWciLCJDcmVkZW50aWFscyIsIlNjaGVtYSJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsYUFBZTs7ZUFFRCxJQUZDOztrQ0FJa0I7O0NBSmpDOztBQ0dBLGlCQUFlO1lBQUEsc0JBRUM7NEJBQ1VBLE9BQU9DLFNBQXpCO0tBSE87YUFBQSx1QkFNRTs0QkFDU0QsT0FBT0MsU0FBekI7S0FQTzthQUFBLHFCQVVBQyxJQVZBLEVBVU07ZUFDTixhQUFXRixPQUFPQyxTQUFsQiw4QkFBb0RDLElBQTNEOztDQVhSOztBQ0RBLElBQUlDLFFBQVEsU0FBUkEsS0FBUSxDQUFTQyxNQUFULEVBQWlCQyxPQUFqQixFQUEwQkMsR0FBMUIsRUFBK0JDLEVBQS9CLEVBQWtDOztRQUV0Q0MsT0FBTyxJQUFYO1FBQ0lILE9BQUosRUFBYTtlQUNGSSxLQUFLQyxTQUFMLENBQWVMLE9BQWYsQ0FBUDs7O1FBR0FNLE1BQU0sSUFBSUMsY0FBSixFQUFWOztRQUVJQyxrQkFBSixHQUF5QixZQUFZO1lBQy9CRixJQUFJRyxVQUFKLEtBQW1CLENBQXZCLEVBQTBCO2dCQUNwQjtvQkFDSUMsT0FBT04sS0FBS08sS0FBTCxDQUFXTCxJQUFJTSxZQUFmLENBQVg7Ozs7b0JBSUlGLEtBQUtHLE9BQUwsSUFBYyxLQUFkLElBQXVCLEVBQUVQLElBQUlRLE1BQUosSUFBYyxHQUFkLElBQXFCUixJQUFJUSxNQUFKLEdBQWEsR0FBcEMsQ0FBM0IsRUFBc0U7dUJBQy9ESixJQUFILEVBQVMsSUFBVDtpQkFESixNQUdPO3VCQUNBLElBQUgsRUFBU0EsSUFBVDs7YUFUUixDQVlFLE9BQU9LLENBQVAsRUFBVTt3QkFDQUMsSUFBUixDQUFhLDBEQUFiLEVBQXdFVixJQUFJTSxZQUE1RSxFQUF5RixrQkFBekYsRUFBNEdOLElBQUlMLEdBQWhILEVBQW9ILHFCQUFwSCxFQUEwSUssSUFBSVAsTUFBOUksRUFBcUosY0FBckosRUFBb0tPLEdBQXBLLEVB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
